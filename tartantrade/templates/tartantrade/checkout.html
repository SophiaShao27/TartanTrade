{% extends 'tartantrade/base_others.html' %}
{% load static %}

{% block title %}Checkout - TartanTrade{% endblock %}

{% block extra_css %}
<style>
  .checkout-container {
    max-width: 900px;
    margin: 0 auto;
  }

  .checkout-section {
    background-color: #fff;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    padding: 20px;
    margin-bottom: 20px;
  }

  .section-title {
    color: #dc3545;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 15px;
  }

  .order-summary-item {
    display: flex;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
  }

  .order-summary-item img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 5px;
    margin-right: 15px;
  }

  .order-summary-item-details {
    flex: 1;
  }

  .order-total {
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    font-size: 1.1rem;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #ddd;
  }

  .btn-primary {
    background-color: #dc3545;
    border: none;
  }

  .btn-primary:hover {
    background-color: #bb2d3b;
  }

  #payment-form {
    margin-top: 20px;
  }

  #card-element {
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 12px;
    background-color: #f8f9fa;
  }

  #card-errors {
    color: #dc3545;
    margin-top: 10px;
  }

  .payment-method-option {
    margin-bottom: 15px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    cursor: pointer;
  }

  .payment-method-option.selected {
    border-color: #dc3545;
    background-color: rgba(220, 53, 69, 0.05);
  }
</style>
{% endblock %}

{% block content %}
<!-- Messages -->
{% if messages %}
<div class="container mt-3">
  {% for message in messages %}
    <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  {% endfor %}
</div>
{% endif %}

<div class="container mt-4 checkout-container">
  <h3 class="text-center text-danger fw-bold mb-4">Checkout</h3>

  <div class="row">
    <!-- Left Column - Order Details -->
    <div class="col-md-7">
      <!-- Shipping Information -->
      <div class="checkout-section">
        <h4 class="section-title">Shipping Information</h4>
        <form id="shipping-form">
          <div class="mb-3">
            <label for="fullName" class="form-label">Full Name</label>
            <input type="text" class="form-control" id="fullName" name="fullName" required value="{{ request.user.get_full_name }}">
          </div>

          <div class="row mb-3">
            <div class="col">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control" id="email" name="email" required value="{{ request.user.email }}">
            </div>
            <div class="col">
              <label for="phone" class="form-label">Phone Number</label>
              <input type="tel" class="form-control" id="phone" name="phone" required>
            </div>
          </div>

          <div class="mb-3">
            <label for="address" class="form-label">Address</label>
            <input type="text" class="form-control" id="address" name="address" required>
          </div>

          <div class="row mb-3">
            <div class="col">
              <label for="city" class="form-label">City</label>
              <input type="text" class="form-control" id="city" name="city" required>
            </div>
            <div class="col">
              <label for="state" class="form-label">State</label>
              <input type="text" class="form-control" id="state" name="state" required>
            </div>
            <div class="col">
              <label for="zipCode" class="form-label">ZIP Code</label>
              <input type="text" class="form-control" id="zipCode" name="zipCode" required>
            </div>
          </div>
        </form>
      </div>

      <!-- Payment Method -->
      <div class="checkout-section">
        <h4 class="section-title">Payment Method</h4>

        <div class="payment-method-option selected" onclick="selectPaymentMethod(this, 'credit_card')">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" id="creditCard" value="credit_card" checked>
            <label class="form-check-label" for="creditCard">
              <strong>Credit/Debit Card</strong>
            </label>
          </div>
          <div class="mt-2" id="card-payment-container">
            <div id="card-element">
              <!-- Stripe Card Element will be inserted here -->
              <div class="p-3 text-center text-muted">
                <i class="fas fa-credit-card me-2"></i> Card details will be securely collected
              </div>
            </div>
            <div id="card-errors" role="alert"></div>
          </div>
        </div>

        <div class="payment-method-option" onclick="selectPaymentMethod(this, 'paypal')">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" id="paypal" value="paypal">
            <label class="form-check-label" for="paypal">
              <strong>PayPal</strong>
            </label>
          </div>
        </div>

        <div class="payment-method-option" onclick="selectPaymentMethod(this, 'in_person')">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="paymentMethod" id="inPerson" value="in_person">
            <label class="form-check-label" for="inPerson">
              <strong>In-Person Exchange</strong>
            </label>
          </div>
          <p class="text-muted small mt-1">Arrange a time and place to meet with the seller.</p>
        </div>
      </div>
    </div>

    <!-- Right Column - Order Summary -->
    <div class="col-md-5">
      <div class="checkout-section">
        <h4 class="section-title">Order Summary</h4>

        <div id="order-summary">
          {% for cart_item in cart_items %}
            <div class="order-summary-item">
              <img src="{% if cart_item.item.picture %}{{ cart_item.item.picture.url }}{% else %}https://via.placeholder.com/60{% endif %}" alt="{{ cart_item.item.title }}">
              <div class="order-summary-item-details">
                <h6 class="mb-0">{{ cart_item.item.title }}</h6>
                <p class="text-muted small mb-0">Qty: {{ cart_item.quantity }}</p>
                <p class="text-muted small mb-0">Seller: {{ cart_item.item.user.username }}</p>
              </div>
              <div class="ms-auto">
                <span class="fw-bold">${{ cart_item.item_total }}</span>
              </div>
            </div>
          {% endfor %}

          <div class="order-total">
            <span>Total:</span>
            <span class="text-danger">${{ total_price }}</span>
          </div>
        </div>

        <div class="mt-4">
          <form id="checkout-form" method="post" action="{% url 'process_order' %}">
            {% csrf_token %}
            <input type="hidden" name="shipping_address" id="shipping_address_combined">
            <input type="hidden" name="payment_method" id="payment_method" value="credit_card">

            <button type="submit" class="btn btn-primary btn-lg w-100" id="place-order-btn">
              Place Order
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://js.stripe.com/v3/"></script>
<script>
  // Function to select payment method
  function selectPaymentMethod(element, method) {
    // Remove the selected class from all options
    document.querySelectorAll('.payment-method-option').forEach(option => {
      option.classList.remove('selected');
    });

    // Add the selected class to the clicked option
    element.classList.add('selected');

    // Update the selected payment method in the hidden input
    document.getElementById('payment_method').value = method;

    // Update radio button
    document.querySelector(`input[value="${method}"]`).checked = true;
  }

  // Handle form submission
  document.getElementById('checkout-form').addEventListener('submit', function(event) {
    // Prevent the default form submission
    event.preventDefault();

    // Validate shipping form
    const shippingForm = document.getElementById('shipping-form');
    if (!shippingForm.checkValidity()) {
      shippingForm.reportValidity();
      return;
    }

    // Combine address fields for backend processing
    const fullName = document.getElementById('fullName').value;
    const address = document.getElementById('address').value;
    const city = document.getElementById('city').value;
    const state = document.getElementById('state').value;
    const zipCode = document.getElementById('zipCode').value;

    const combinedAddress = `${fullName}, ${address}, ${city}, ${state} ${zipCode}`;
    document.getElementById('shipping_address_combined').value = combinedAddress;

    // If using credit card, handle Stripe payment
    const paymentMethod = document.getElementById('payment_method').value;
    if (paymentMethod === 'credit_card') {
      // Here you would normally handle Stripe payment
      // For this template, we'll simulate a successful payment
      console.log('Processing credit card payment...');
    }

    // Submit the form
    this.submit();
  });

  // Initialize page
  document.addEventListener('DOMContentLoaded', function() {
    // Pre-fill address if available from profile
  });
</script>
{% endblock %}