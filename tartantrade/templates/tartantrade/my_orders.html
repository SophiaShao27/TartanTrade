{% extends 'tartantrade/base.html' %}
{% load static %}

{% block title %}My Orders - TartanTrade{% endblock %}

{% block extra_css %}
<style>
  .order-card {
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    overflow: hidden;
  }

  .order-header {
    background-color: #f8f9fa;
    padding: 15px;
    border-bottom: 1px solid #eee;
  }

  .order-body {
    padding: 15px;
  }

  .order-item {
    display: flex;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
  }

  .order-item:last-child {
    border-bottom: none;
  }

  .order-item img {
    width: 70px;
    height: 70px;
    object-fit: cover;
    border-radius: 5px;
    margin-right: 15px;
  }

  .order-item-details {
    flex: 1;
  }

  .order-status {
    font-weight: bold;
  }

  .status-pending {
    color: #ffc107;
  }

  .status-paid {
    color: #17a2b8;
  }

  .status-shipped {
    color: #6f42c1;
  }

  .status-completed {
    color: #28a745;
  }

  .status-cancelled {
    color: #dc3545;
  }

  .pagination {
    justify-content: center;
    margin-top: 30px;
  }

  .btn-primary {
    background-color: #dc3545;
    border: none;
  }

  .btn-primary:hover {
    background-color: #bb2d3b;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h3 class="text-center text-danger fw-bold mb-4">My Orders</h3>

  {% if page_obj %}
    <div class="orders-container">
      {% for order in page_obj %}
        <div class="order-card">
          <div class="order-header d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-0">Order #{{ order.order_number }}</h5>
              <p class="text-muted mb-0 small">Placed on {{ order.created_time|date:"M d, Y" }}</p>
            </div>
            <div class="text-end">
              <span class="order-status status-{{ order.status }}">
                {{ order.get_status_display }}
              </span>
              <p class="mb-0">${{ order.total_price }}</p>
            </div>
          </div>

          <div class="order-body">
            <div class="order-item">
              <img src="{% if order.item.picture %}{{ order.item.picture.url }}{% else %}https://via.placeholder.com/70{% endif %}" alt="{{ order.item.title }}">
              <div class="order-item-details">
                <h6 class="mb-1">{{ order.item.title }}</h6>
                <p class="text-muted small mb-1">{{ order.item.description|truncatechars:100 }}</p>
                <p class="small mb-0">
                  <span class="text-muted">Seller:</span> {{ order.seller.username }}
                  {% if order.payment_method %}
                    <span class="mx-2">â€¢</span>
                    <span class="text-muted">Payment:</span> {{ order.payment_method }}
                  {% endif %}
                </p>
              </div>
            </div>

            <div class="mt-3 d-flex justify-content-between">
              <div>
                <strong>Shipping Address:</strong>
                <p class="mb-0">{{ order.shipping_address }}</p>
              </div>

              <div class="text-end">
                {% if order.status == 'completed' %}
                  <a href="#" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-star me-1"></i> Rate Seller
                  </a>
                {% elif order.status == 'shipped' %}
                  <form method="post" action="{% url 'complete_order' order.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary btn-sm">
                      <i class="fas fa-check me-1"></i> Confirm Receipt
                    </button>
                  </form>
                {% endif %}

                <a href="#" class="btn btn-outline-secondary btn-sm ms-2">
                  <i class="fas fa-comment me-1"></i> Contact Seller
                </a>
              </div>
            </div>

            {% if order.remarks %}
              <div class="mt-3">
                <strong>Remarks:</strong>
                <p class="small mb-0">{{ order.remarks }}</p>
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}

      <!-- Pagination -->
      {% if page_obj.paginator.num_pages > 1 %}
        <nav aria-label="Page navigation">
          <ul class="pagination">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1" aria-label="First">
                  <span aria-hidden="true">&laquo;&laquo;</span>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
              {% if page_obj.number == num %}
                <li class="page-item active">
                  <span class="page-link">{{ num }}</span>
                </li>
              {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                </li>
              {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" aria-label="Last">
                  <span aria-hidden="true">&raquo;&raquo;</span>
                </a>
              </li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    </div>
  {% else %}
    <div class="text-center my-5 py-5">
      <h5>You haven't placed any orders yet</h5>
      <p class="text-muted">Start shopping to see your orders here!</p>
      <a href="{% url 'home' %}" class="btn btn-primary mt-3">Start Shopping</a>
    </div>
  {% endif %}
</div>
{% endblock %}